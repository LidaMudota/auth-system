# Auth System

Простая учебная система авторизации с локальными аккаунтами и входом через VK ID. На всех страницах теперь отображается текущая роль пользователя, а переход на главную страницу доступен из любого раздела.

## Возможности
- регистрация и вход по логину/паролю, "запомнить меня" через cookie;
- вход через VK ID с PKCE;
- отображение роли (или состояния "неавторизирован") на каждой странице;
- демонстрация работы ролей и закрытого раздела;
- запись сообщений в файл и логирование ошибок доступа к нему.

## Подготовка окружения
1. Разверните базу данных MySQL и примените скрипт `db/schema.sql`.
2. При необходимости измените параметры подключения и VK ID в `config/config.php`.
3. Убедитесь, что каталог `storage/` доступен для записи веб-сервером. Для формы сообщений создайте пустой файл `storage/messages.txt`.
4. При необходимости создайте учётную запись администратора, открыв страницу `/seed_admin.php`.

## Запуск локально (PHP)
```bash
php -S 127.0.0.1:8000 -t public
```
После запуска главная страница будет доступна по адресу `http://127.0.0.1:8000/`.

## Публикация сервиса наружу
### Через Node.js и LocalTunnel
```bash
npx localtunnel --port 8000 --subdomain ваша_поддоменная_часть
```
LocalTunnel выдаст публичный URL, который можно использовать для OAuth-переадресации и тестирования.

### Через ngrok
```bash
ngrok http 8000
```
Ngrok сформирует временный HTTPS-адрес. Не забудьте обновить redirect URI в настройках VK ID, если используете этот способ.

### Готовое окружение
Если не хочется настраивать локальную машину, можно воспользоваться уже готовой средой по адресу [http://tri-sobaki.ru/](http://tri-sobaki.ru/).

## Структура проекта
- `public/` — конечные точки и статические ресурсы;
- `src/` — небольшие служебные модули (аутентификация, CSRF, навигационная плашка и т.д.);
- `storage/` — файлы, которые создаёт приложение во время работы;
- `config/` — конфигурация базы данных, VK ID и логов.

## Полезные страницы
- `/login.php` — форма входа;
- `/register.php` — регистрация нового пользователя;
- `/protected.php` — закрытый раздел (доступен после входа);
- `/role_demo.php` — кнопка, доступная только роли `admin`;
- `/messages.php` — отправка сообщений в файл `storage/messages.txt`;
- `/seed_admin.php` — разовое создание администратора.

## Журналы и временные файлы
Журналы авторизации попадают в `storage/logs/auth.log` (создаётся автоматически). Для сообщений используется `storage/log.txt`. Эти файлы игнорируются Git и создаются при необходимости.